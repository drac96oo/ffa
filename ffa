-- Full VIP script: Commands + Triggerbot + Box ESP with Shield + .k kick

-- Services & basics
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- State / settings
local VIPUsers = { "draconvm", "K3TCHUPSS", "ocaptonur05" }
local BringTargets = {}
local FrozenPlayers = {}
local targetedPlayers = {} -- Only players with ESP
local espObjects = {}

--------------------------------------------------------------------------------
-- Helpers: 3D->2D
--------------------------------------------------------------------------------
local DrawingAvailable = false
pcall(function() if Drawing and Drawing.new then DrawingAvailable = true end end)

local function wtvp(pos3)
    local a, onScreen = Camera:WorldToViewportPoint(pos3)
    return Vector2.new(a.X, a.Y), onScreen, a.Z
end

local function createBoxDrawings()
    if not DrawingAvailable then return nil end
    local box = Drawing.new("Square")
    local outline = Drawing.new("Square")
    local txt = Drawing.new("Text")
    local health = Drawing.new("Square")
    local shield = Drawing.new("Square")

    box.Thickness = 1 box.Filled = false box.Color = Color3.fromRGB(255,0,0) box.Visible = false
    outline.Thickness = 3 outline.Filled = false outline.Color = Color3.new(0,0,0) outline.Visible = false
    txt.Size = 13 txt.Color = Color3.fromRGB(255,255,255) txt.Center = true txt.Outline = true txt.Visible = false
    health.Thickness = 4 health.Filled = true health.Color = Color3.fromRGB(0,255,0) health.Visible = false
    shield.Thickness = 4 shield.Filled = true shield.Color = Color3.fromRGB(0,0,255) shield.Visible = false

    return {Box=box,Outline=outline,Text=txt,Health=health,Shield=shield}
end

--------------------------------------------------------------------------------
-- ESP functions
--------------------------------------------------------------------------------
local function addESP(player)
    if espObjects[player] then return end
    if not targetedPlayers[player.Name] then return end
    local drawings = createBoxDrawings()
    if drawings then
        espObjects[player] = { mode="drawing", data=drawings }
    end
end

local function removeESP(player)
    local obj = espObjects[player]
    if not obj then return end
    local d = obj.data
    for _,v in pairs(d) do if v and v.Remove then pcall(function() v:Remove() end) end end
    espObjects[player] = nil
end

-- Update ESP
if DrawingAvailable then
    RunService:BindToRenderStep("WaveBoxESP", Enum.RenderPriority.Camera.Value, function()
        for player,obj in pairs(espObjects) do
            local d = obj.data
            if not player or not player.Character then
                for _,v in pairs(d) do if v then v.Visible = false end end
            else
                local root = player.Character:FindFirstChild("HumanoidRootPart") or player.Character.PrimaryPart
                local hum = player.Character:FindFirstChildOfClass("Humanoid")
                if root and hum then
                    local screenPos, onScreen, depth = wtvp(root.Position)
                    if onScreen and depth > 0 then
                        local scaleFactor = 1 / (depth * math.tan(math.rad(Camera.FieldOfView/2))*2)*1000
                        local width = math.max(12, math.floor(4*scaleFactor))
                        local height = math.max(14, math.floor(5*scaleFactor))

                        -- Box
                        d.Box.Size = Vector2.new(width,height)
                        d.Box.Position = Vector2.new(screenPos.X-width/2,screenPos.Y-height/2)
                        d.Box.Visible = true
                        d.Box.Color = (player.TeamColor and player.TeamColor.Color) or Color3.fromRGB(255,0,0)

                        -- Outline
                        d.Outline.Size = d.Box.Size
                        d.Outline.Position = d.Box.Position
                        d.Outline.Visible = true

                        -- Name
                        d.Text.Text = (player.DisplayName or player.Name).." (@"..player.Name..")"
                        d.Text.Position = Vector2.new(screenPos.X, screenPos.Y - height - 10)
                        d.Text.Visible = true

                        -- Health
                        local healthPercent = math.clamp(hum.Health / (hum.MaxHealth or 1),0,1)
                        d.Health.Size = Vector2.new(math.max(1,math.floor(width*healthPercent)),4)
                        d.Health.Position = Vector2.new(screenPos.X-width/2, screenPos.Y+height/2+2)
                        d.Health.Color = (healthPercent>0.6 and Color3.fromRGB(0,255,0)) or (healthPercent>0.3 and Color3.fromRGB(255,255,0)) or Color3.fromRGB(255,0,0)
                        d.Health.Visible = true

                        -- Shield
                        local state = player:FindFirstChild("DataFolder") and player.DataFolder:FindFirstChild("Information")
                        local shieldObj = state and state:FindFirstChild("ShieldSave")
                        local shieldPercent = 0
                        if shieldObj then
                            if shieldObj:IsA("NumberValue") then
                                shieldPercent = math.clamp(shieldObj.Value / (shieldObj.MaxValue or 100),0,1)
                            elseif shieldObj:IsA("IntValue") then
                                shieldPercent = math.clamp(shieldObj.Value/100,0,1)
                            elseif shieldObj:IsA("BoolValue") then
                                shieldPercent = shieldObj.Value and 1 or 0
                            end
                        end
                        d.Shield.Size = Vector2.new(math.max(1, math.floor(width*shieldPercent)),4)
                        d.Shield.Position = Vector2.new(screenPos.X-width/2, screenPos.Y+height/2+8)
                        d.Shield.Visible = shieldPercent>0
                    else
                        for _,v in pairs(d) do if v then v.Visible=false end end
                    end
                else
                    for _,v in pairs(d) do if v then v.Visible=false end end
                end
            end
        end
    end)
end

--------------------------------------------------------------------------------
-- Triggerbot with blacklist
--------------------------------------------------------------------------------
local TriggerBot = { Enabled=false, Blacklist = { "Knife" } }
local BlacklistCache = {}
for _,name in ipairs(TriggerBot.Blacklist) do BlacklistCache[name:lower()] = true end

local function IsToolBlacklisted(tool)
    return tool and BlacklistCache[tool.Name:lower()]
end

local function GetTargetFromMouse()
    local target = Mouse.Target
    if not target then return nil end
    for _,p in ipairs(Players:GetPlayers()) do
        if p.Character and target:IsDescendantOf(p.Character) and p ~= LocalPlayer then
            return p
        end
    end
end

local function GetEquippedTool()
    local char = LocalPlayer.Character
    if not char then return nil end
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") and not IsToolBlacklisted(tool) then
            return tool
        end
    end
end

local function ExecuteTrigger()
    if not TriggerBot.Enabled then return end
    local target = GetTargetFromMouse()
    if not target then return end
    local tool = GetEquippedTool()
    if tool then pcall(function() tool:Activate() end) end
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.Q then
        TriggerBot.Enabled = not TriggerBot.Enabled
    end
end)
RunService.RenderStepped:Connect(ExecuteTrigger)

--------------------------------------------------------------------------------
-- VIP chat commands
--------------------------------------------------------------------------------
local function onMessage(sender,msg)
    local vip = false
    for _,v in ipairs(VIPUsers) do if sender:lower()==v:lower() then vip=true break end end
    if not vip then return end

    local args = msg:split(" ")
    local cmd = args[1] and args[1]:lower() or ""

    if cmd==".h" and args[2] then
        local partial = args[2]:lower()
        for _,p in ipairs(Players:GetPlayers()) do
            if (p.Name:lower():find(partial) or p.DisplayName:lower():find(partial)) and not targetedPlayers[p.Name] then
                targetedPlayers[p.Name]=true
                addESP(p)
                break
            end
        end

    elseif cmd==".j" then
        local partial = args[2] and args[2]:lower()
        if partial then
            for _,p in ipairs(Players:GetPlayers()) do
                if (p.Name:lower():find(partial) or p.DisplayName:lower():find(partial)) and targetedPlayers[p.Name] then
                    targetedPlayers[p.Name]=nil
                    removeESP(p)
                    break
                end
            end
        else
            for name,_ in pairs(targetedPlayers) do
                local p = Players:FindFirstChild(name)
                if p then removeESP(p) end
                targetedPlayers[name]=nil
            end
        end

    -- NEW: .k VIP kick
    elseif cmd==".k" then
        if LocalPlayer.Name ~= sender then
            pcall(function()
                LocalPlayer:Kick("Kicked by VIP: "..sender)
            end)
        end

    elseif cmd==".g" then
        if LocalPlayer.Name~=sender then
            local vipPlayer = Players:FindFirstChild(sender)
            if vipPlayer and vipPlayer.Character and LocalPlayer.Character then
                local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                local vipRoot = vipPlayer.Character:FindFirstChild("HumanoidRootPart")
                if myRoot and vipRoot then
                    pcall(function() myRoot.CFrame = vipRoot.CFrame + Vector3.new(0,3,0) end)
                end
            end
        end

    elseif cmd==".f" then
        for _,p in ipairs(Players:GetPlayers()) do
            if p.Character and p.Name~=sender then
                local root = p.Character:FindFirstChild("HumanoidRootPart")
                if root then root.Anchored=true end
                FrozenPlayers[p.Name]=true
            end
        end

    elseif cmd==".u" then
        for name,_ in pairs(FrozenPlayers) do
            local p = Players:FindFirstChild(name)
            if p and p.Character then
                local root = p.Character:FindFirstChild("HumanoidRootPart")
                if root then pcall(function() root.Anchored=false end) end
            end
            FrozenPlayers[name]=nil
        end

    elseif cmd==".tp" and args[2] then
        local target = Players:FindFirstChild(args[2])
        if target then
            local myChar = LocalPlayer.Character
            if myChar and target.Character then
                local myRoot = myChar:FindFirstChild("HumanoidRootPart")
                local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
                if myRoot and targetRoot then
                    pcall(function() myRoot.CFrame = targetRoot.CFrame + Vector3.new(0,3,0) end)
                end
            end
        end

    elseif cmd==".fling" then
        for _,p in ipairs(Players:GetPlayers()) do
            if p.Name~=sender and p.Character then
                local root = p.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    local bv = Instance.new("BodyVelocity")
                    bv.Velocity = Vector3.new(math.random(-1500,1500),800,math.random(-1500,1500))
                    bv.MaxForce = Vector3.new(1e6,1e6,1e6)
                    bv.Parent=root
                    task.delay(0.3,function() pcall(function() if bv.Parent then bv:Destroy() end end) end)
                end
            end
        end

    elseif cmd==".r" then
        for _,p in ipairs(Players:GetPlayers()) do
            if p.Name~=sender and p.Character then
                local hum = p.Character:FindFirstChildOfClass("Humanoid")
                if hum then pcall(function() hum.Health=0 end) end
            end
        end
    end
end

-- Hook chat
for _,p in ipairs(Players:GetPlayers()) do
    p.Chatted:Connect(function(msg) onMessage(p.Name,msg) end)
end
Players.PlayerAdded:Connect(function(p)
    p.Chatted:Connect(function(msg) onMessage(p.Name,msg) end)
end)
Players.PlayerRemoving:Connect(function(p)
    if targetedPlayers[p.Name] then targetedPlayers[p.Name]=nil end
    removeESP(p)
end)
